<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ReumaCare | Soporte a la Decisión Clínica</title>
    <meta name="description" content="Herramienta profesional de soporte para enfermería reumatológica">
    
    <!-- Fuentes e Iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        clinical: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a', 
                        },
                        accent: {
                            500: '#0d9488', // Teal clinical
                            600: '#0f766e',
                            50: '#f0fdfa',
                        },
                        severity: {
                            low: '#10b981', // Green
                            mod: '#f59e0b', // Amber
                            high: '#ef4444', // Red
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Ajustes UI */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .slide-over { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .custom-checkbox:checked { background-color: #0d9488; border-color: #0d9488; }
        
        /* Interactive Number Strip */
        .num-btn {
            @apply flex-1 h-10 flex items-center justify-center border border-clinical-300 rounded bg-white text-sm font-medium transition-all cursor-pointer select-none;
        }
        .num-btn:hover { @apply bg-clinical-50 border-clinical-400; }
        .num-btn.selected { @apply bg-accent-500 text-white border-accent-600 shadow-sm; }

        /* Modal Transitions */
        .modal-enter { opacity: 0; pointer-events: none; transition: opacity 0.2s ease-in-out; }
        .modal-enter-active { opacity: 1; pointer-events: auto; }
        .modal-content-enter { transform: scale(0.95); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .modal-content-active { transform: scale(1); opacity: 1; }
    </style>
</head>
<body class="bg-clinical-50 text-clinical-800 antialiased h-screen flex overflow-hidden selection:bg-accent-500 selection:text-white">

    <!-- WELCOME SCREEN (SPLASH) -->
    <div id="welcome-screen" class="fixed inset-0 z-50 bg-clinical-50 flex flex-col items-center justify-center p-6 transition-transform duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-clinical-200 text-center">
            <div class="flex justify-center mb-6">
                <div class="p-4 bg-accent-50 rounded-full text-accent-600">
                    <i data-lucide="activity" class="w-10 h-10"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold text-clinical-900 mb-2">ReumaCare</h1>
            <p class="text-xs text-clinical-500 uppercase tracking-widest font-semibold mb-8">Soporte Integral para la Consulta de Enfermería Reumatológica</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium text-clinical-700 mb-1">Nombre del Profesional</label>
                    <input type="text" id="welcome-nurse" class="w-full p-3 border border-clinical-300 rounded-lg focus:ring-2 focus:ring-accent-500 outline-none" placeholder="Ej. Dña. Laura García">
                </div>
                <div>
                    <label class="block text-sm font-medium text-clinical-700 mb-1">Centro Hospitalario</label>
                    <input type="text" id="welcome-hospital" class="w-full p-3 border border-clinical-300 rounded-lg focus:ring-2 focus:ring-accent-500 outline-none" placeholder="Ej. Hospital Universitario...">
                </div>
                <button onclick="startApp()" class="w-full py-3 mt-4 bg-clinical-900 text-white rounded-lg font-bold hover:bg-clinical-800 transition-colors shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
                    Iniciar Consulta <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
            <p class="text-xs text-clinical-400 mt-6">Los datos se guardarán localmente para futuros informes.</p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-clinical-200 flex flex-col justify-between shadow-sm z-20 hidden md:flex">
        <div>
            <!-- Header Logo Limpio -->
            <button onclick="goToHome()" class="h-16 w-full flex items-center px-6 border-b border-clinical-100 hover:bg-clinical-50 transition-colors text-left focus:outline-none">
                <div class="flex items-center gap-2 text-clinical-900 font-bold text-lg">
                    <i data-lucide="activity" class="text-accent-500"></i>
                    <span>ReumaCare</span>
                </div>
            </button>
            
            <div class="p-4 space-y-1 border-b border-clinical-100">
                <button onclick="goToHome()" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-clinical-600 hover:bg-clinical-50 hover:text-clinical-900 transition-colors focus:outline-none">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    Inicio
                </button>
                <div id="sidebar-info" class="px-3 py-2 text-xs text-clinical-400">
                    <!-- Se llena dinámicamente con Nurse/Hospital -->
                </div>
            </div>

            <div class="p-6">
                <div class="text-xs font-semibold text-clinical-400 uppercase tracking-wider mb-4">Paciente Actual</div>
                
                <!-- Campos de Identificación -->
                <div class="mb-3">
                    <label class="block text-xs text-clinical-500 mb-1">Nombre (Opcional)</label>
                    <input type="text" id="patient-name-input" class="w-full text-sm p-1 border-b border-clinical-300 focus:border-accent-500 outline-none bg-transparent placeholder-clinical-300" placeholder="Nombre y Apellidos" oninput="currentPatient.name = this.value; saveState();">
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-clinical-500 mb-1">ID / NHC (Opcional)</label>
                    <input type="text" id="patient-id-input" class="w-full text-sm p-1 border-b border-clinical-300 focus:border-accent-500 outline-none bg-transparent placeholder-clinical-300" placeholder="Número de Historia" oninput="currentPatient.id = this.value; saveState();">
                </div>

                <div id="sidebar-context" class="space-y-4 opacity-50 transition-opacity duration-300">
                    <div>
                        <label class="block text-xs text-clinical-500 mb-1">Patología</label>
                        <div id="ctx-pathology" class="font-medium text-clinical-800 text-sm">Seleccionar...</div>
                    </div>
                    <div>
                        <label class="block text-xs text-clinical-500 mb-1">Tipo de Visita</label>
                        <div id="ctx-visit" class="font-medium text-clinical-800 text-sm">Seleccionar...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 border-t border-clinical-100 bg-clinical-50 space-y-2">
            <button onclick="exportToPDF()" id="btn-pdf-side" disabled class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white border border-clinical-300 rounded-lg text-sm font-medium text-clinical-700 hover:bg-clinical-50 hover:text-clinical-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                Exportar PDF
            </button>
            <button onclick="generateSummary()" id="btn-copy-side" disabled class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-clinical-800 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-clinical-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="clipboard-copy" class="w-4 h-4"></i>
                Copiar Resumen
            </button>
            <button onclick="triggerReset()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 border border-red-100 rounded-lg text-sm font-medium text-red-700 hover:bg-red-100 transition-colors mt-4">
                <i data-lucide="user-plus" class="w-4 h-4"></i>
                Nuevo Paciente
            </button>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full bg-white border-b border-clinical-200 z-30 px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2 font-bold text-clinical-900" onclick="goToHome()">
            <i data-lucide="activity" class="text-accent-500"></i>
            <span>ReumaCare</span>
        </div>
        <button onclick="triggerReset()" class="p-2 text-clinical-600">
            <i data-lucide="user-plus"></i>
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto relative bg-clinical-50 pt-16 md:pt-0">
        <div class="max-w-4xl mx-auto p-6 md:p-12 pb-24">
            <div id="app-views">
                
                <!-- VIEW 1: PATHOLOGY -->
                <div id="view-pathology" class="view-section fade-in">
                    <h1 class="text-3xl font-bold text-clinical-900 mb-2">Selección de Patología</h1>
                    <p class="text-clinical-500 mb-8 text-lg">Inicie el protocolo seleccionando el diagnóstico principal.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="selectPathology('EA')" class="group p-6 bg-white rounded-xl border border-clinical-200 hover:border-accent-500 hover:shadow-md transition-all text-left">
                            <div class="flex items-center justify-between mb-4"><div class="p-3 bg-clinical-100 rounded-lg text-clinical-600 group-hover:bg-accent-500 group-hover:text-white transition-colors"><i data-lucide="move" class="w-6 h-6"></i></div><i data-lucide="chevron-right" class="text-clinical-300 group-hover:text-accent-500"></i></div>
                            <h3 class="text-lg font-bold text-clinical-800">Espondiloartritis Axial</h3>
                            <p class="text-sm text-clinical-500 mt-1">Columna vertebral y sacroilíacas</p>
                        </button>
                        <button onclick="selectPathology('APs')" class="group p-6 bg-white rounded-xl border border-clinical-200 hover:border-accent-500 hover:shadow-md transition-all text-left">
                            <div class="flex items-center justify-between mb-4"><div class="p-3 bg-clinical-100 rounded-lg text-clinical-600 group-hover:bg-accent-500 group-hover:text-white transition-colors"><i data-lucide="link" class="w-6 h-6"></i></div><i data-lucide="chevron-right" class="text-clinical-300 group-hover:text-accent-500"></i></div>
                            <h3 class="text-lg font-bold text-clinical-800">Artritis Psoriásica</h3>
                            <p class="text-sm text-clinical-500 mt-1">Artropatía y psoriasis asociada</p>
                        </button>
                        <button onclick="selectPathology('AR')" class="group p-6 bg-white rounded-xl border border-clinical-200 hover:border-accent-500 hover:shadow-md transition-all text-left">
                            <div class="flex items-center justify-between mb-4"><div class="p-3 bg-clinical-100 rounded-lg text-clinical-600 group-hover:bg-accent-500 group-hover:text-white transition-colors"><i data-lucide="hand-metal" class="w-6 h-6"></i></div><i data-lucide="chevron-right" class="text-clinical-300 group-hover:text-accent-500"></i></div>
                            <h3 class="text-lg font-bold text-clinical-800">Artritis Reumatoide</h3>
                            <p class="text-sm text-clinical-500 mt-1">Poliartritis simétrica erosiva</p>
                        </button>
                        <button onclick="selectPathology('LES')" class="group p-6 bg-white rounded-xl border border-clinical-200 hover:border-accent-500 hover:shadow-md transition-all text-left">
                            <div class="flex items-center justify-between mb-4"><div class="p-3 bg-clinical-100 rounded-lg text-clinical-600 group-hover:bg-accent-500 group-hover:text-white transition-colors"><i data-lucide="shield-alert" class="w-6 h-6"></i></div><i data-lucide="chevron-right" class="text-clinical-300 group-hover:text-accent-500"></i></div>
                            <h3 class="text-lg font-bold text-clinical-800">Lupus Eritematoso</h3>
                            <p class="text-sm text-clinical-500 mt-1">Enfermedad autoinmune sistémica</p>
                        </button>
                    </div>
                </div>

                <!-- VIEW 2: VISIT TYPE -->
                <div id="view-visit" class="view-section hidden fade-in">
                    <button onclick="goToView('pathology')" class="text-sm text-clinical-500 hover:text-accent-500 mb-4 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver a selección</button>
                    <h1 class="text-3xl font-bold text-clinical-900 mb-2">Motivo de Consulta</h1>
                    <p class="text-clinical-500 mb-8 text-lg">Defina el objetivo de la intervención enfermera.</p>
                    <div class="space-y-3">
                        <button onclick="selectVisitType('inicio')" class="w-full flex items-center p-4 bg-white rounded-lg border border-clinical-200 hover:bg-clinical-50 hover:border-accent-500 transition-all text-left group">
                            <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mr-4 group-hover:bg-blue-600 group-hover:text-white transition-colors"><i data-lucide="flag" class="w-5 h-5"></i></div>
                            <div><h4 class="font-bold text-clinical-800">Inicio de Enfermedad / Tratamiento</h4><p class="text-sm text-clinical-500">Primera visita o confirmación diagnóstica.</p></div>
                        </button>
                        <button onclick="selectVisitType('educacion')" class="w-full flex items-center p-4 bg-white rounded-lg border border-clinical-200 hover:bg-clinical-50 hover:border-accent-500 transition-all text-left group">
                            <div class="h-10 w-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center mr-4 group-hover:bg-purple-600 group-hover:text-white transition-colors"><i data-lucide="book-open" class="w-5 h-5"></i></div>
                            <div><h4 class="font-bold text-clinical-800">Educación Terapéutica</h4><p class="text-sm text-clinical-500">Formación sobre tratamiento prescrito.</p></div>
                        </button>
                        <button onclick="selectVisitType('postinicio')" class="w-full flex items-center p-4 bg-white rounded-lg border border-clinical-200 hover:bg-clinical-50 hover:border-accent-500 transition-all text-left group">
                            <div class="h-10 w-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center mr-4 group-hover:bg-green-600 group-hover:text-white transition-colors"><i data-lucide="phone" class="w-5 h-5"></i></div>
                            <div><h4 class="font-bold text-clinical-800">Seguimiento Telefónico (6 Semanas)</h4><p class="text-sm text-clinical-500">Control post-inicio biológico.</p></div>
                        </button>
                        <button onclick="selectVisitType('seguimiento')" class="w-full flex items-center p-4 bg-white rounded-lg border border-clinical-200 hover:bg-clinical-50 hover:border-accent-500 transition-all text-left group">
                            <div class="h-10 w-10 rounded-full bg-clinical-100 text-clinical-600 flex items-center justify-center mr-4 group-hover:bg-clinical-600 group-hover:text-white transition-colors"><i data-lucide="clipboard-list" class="w-5 h-5"></i></div>
                            <div><h4 class="font-bold text-clinical-800">Seguimiento Regular</h4><p class="text-sm text-clinical-500">Control rutinario semestral.</p></div>
                        </button>
                        <button onclick="selectVisitType('brote')" class="w-full flex items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:bg-red-100 hover:border-red-400 transition-all text-left group">
                            <div class="h-10 w-10 rounded-full bg-white text-red-600 flex items-center justify-center mr-4 shadow-sm"><i data-lucide="alert-triangle" class="w-5 h-5"></i></div>
                            <div><h4 class="font-bold text-red-800">Atención de Brote</h4><p class="text-sm text-red-600">Empeoramiento o crisis de la enfermedad.</p></div>
                        </button>
                    </div>
                </div>

                <!-- VIEW 3: CONTENT -->
                <div id="view-content" class="view-section hidden fade-in">
                    <button onclick="goToView('visit')" class="text-sm text-clinical-500 hover:text-accent-500 mb-4 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver a tipos de visita</button>
                    <div class="flex items-center justify-between mb-6">
                        <h1 id="content-header-title" class="text-2xl font-bold text-clinical-900">Protocolo Activo</h1>
                        <span id="content-duration" class="px-3 py-1 bg-clinical-100 text-clinical-600 rounded-full text-xs font-medium flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> <span id="dur-text"></span></span>
                    </div>
                    <div id="alerts-area" class="space-y-3 mb-8"></div>
                    <div id="checklist-renderer" class="space-y-8"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- SLIDE-OVER CALCULATOR -->
    <div id="slide-over-backdrop" class="fixed inset-0 bg-clinical-900/20 backdrop-blur-sm z-40 hidden transition-opacity" onclick="closeCalculator()"></div>
    <div id="calculator-panel" class="fixed top-0 right-0 h-full w-full md:w-[680px] bg-white shadow-2xl transform translate-x-full slide-over z-50 flex flex-col">
        <div class="p-4 border-b border-clinical-200 flex items-center justify-between bg-clinical-50">
            <h3 class="font-bold text-lg text-clinical-800 flex items-center gap-2"><i data-lucide="calculator" class="text-accent-500"></i><span id="calc-title">Calculadora</span></h3>
            <button onclick="closeCalculator()" class="p-2 text-clinical-400 hover:text-clinical-700 rounded-full hover:bg-clinical-200"><i data-lucide="x"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="calc-body"></div>
        <div class="p-4 border-t border-clinical-200 bg-clinical-50">
            <button onclick="performCalculation()" class="w-full py-3 bg-clinical-900 text-white rounded-lg font-medium hover:bg-clinical-800 transition-all flex items-center justify-center gap-2">Calcular y Guardar <i data-lucide="check" class="w-4 h-4"></i></button>
            <div id="calc-result-display" class="mt-3 hidden p-4 rounded-lg text-center font-bold text-lg border"></div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-enter">
        <div class="absolute inset-0 bg-clinical-900/40 backdrop-blur-sm transition-opacity"></div>
        <div class="relative bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden border border-clinical-200 modal-content-enter">
            <div class="p-6">
                <h3 class="text-lg font-bold text-clinical-900 flex items-center gap-2 mb-2"><i data-lucide="alert-triangle" class="text-amber-500 w-5 h-5"></i> Confirmar Acción</h3>
                <p id="modal-message" class="text-clinical-600 text-sm leading-relaxed"></p>
            </div>
            <div class="bg-clinical-50 px-6 py-4 flex justify-end gap-3 border-t border-clinical-100">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-clinical-600 hover:text-clinical-800 hover:bg-clinical-200 rounded-lg">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-clinical-900 hover:bg-clinical-800 rounded-lg shadow-sm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-4 right-4 bg-clinical-900 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all z-50 flex items-center gap-3">
        <i id="toast-icon" data-lucide="check-circle" class="text-accent-500"></i>
        <span id="toast-message">Acción completada</span>
    </div>

    <!-- LOGIC -->
    <script>
        let currentPatient = { id: '', name: '', pathology: null, visitType: null, eva: null, scores: {}, checklist: {}, alerts: [] };
        let sessionSettings = { nurse: '', hospital: '' }; // Datos de sesión
        
        const pathologyData = {
            'EA': { name: 'Espondiloartritis Axial', icon: 'move' },
            'APs': { name: 'Artritis Psoriásica', icon: 'link' },
            'AR': { name: 'Artritis Reumatoide', icon: 'hand-metal' },
            'LES': { name: 'Lupus Eritematoso', icon: 'shield-alert' }
        };
        const visitData = {
            'inicio': 'Inicio de Enfermedad',
            'educacion': 'Educación Terapéutica',
            'postinicio': 'Seguimiento Telefónico (6 sem)',
            'seguimiento': 'Seguimiento Regular',
            'brote': 'Atención de Brote'
        };

        // --- CORE FUNCTIONS ---
        document.addEventListener('DOMContentLoaded', () => { 
            lucide.createIcons(); 
            checkWelcome(); // Comprobar si mostramos bienvenida
            loadState(); 
        });

        // --- WELCOME SCREEN LOGIC ---
        function checkWelcome() {
            const savedSettings = localStorage.getItem('reuma_settings');
            if (savedSettings) {
                sessionSettings = JSON.parse(savedSettings);
                document.getElementById('welcome-nurse').value = sessionSettings.nurse;
                document.getElementById('welcome-hospital').value = sessionSettings.hospital;
            }
            // Siempre mostramos para confirmar, pero si ya hay datos, es rápido.
            // Para "autologin" si se prefiere, descomentar:
            // if(savedSettings) startApp();
        }

        function startApp() {
            const nurse = document.getElementById('welcome-nurse').value;
            const hospital = document.getElementById('welcome-hospital').value;
            
            if (!nurse || !hospital) {
                alert("Por favor, introduzca sus datos para configurar los informes.");
                return;
            }

            sessionSettings = { nurse, hospital };
            localStorage.setItem('reuma_settings', JSON.stringify(sessionSettings));
            
            // Ocultar Splash
            const splash = document.getElementById('welcome-screen');
            splash.classList.add('-translate-y-full'); // Animación salida hacia arriba
            
            // Actualizar Sidebar Info
            updateSidebarInfo();
        }

        function updateSidebarInfo() {
            const infoDiv = document.getElementById('sidebar-info');
            infoDiv.innerHTML = `
                <div class="flex flex-col gap-1 mt-2 pt-2 border-t border-clinical-100">
                    <span class="font-semibold text-clinical-600 truncate">${sessionSettings.nurse}</span>
                    <span class="text-[10px] text-clinical-400 truncate">${sessionSettings.hospital}</span>
                </div>
            `;
        }

        // --- APP NAVIGATION ---
        function selectPathology(code) {
            currentPatient.pathology = code;
            currentPatient.pathologyName = pathologyData[code].name;
            saveState();
            goToView('visit');
            updateSidebarContext();
        }

        function selectVisitType(type) {
            currentPatient.visitType = type;
            currentPatient.visitName = visitData[type];
            currentPatient.scores = {}; currentPatient.alerts = [];
            saveState();
            loadChecklistContent();
            goToView('content');
            updateSidebarContext();
            enableSideActions(true);
        }

        function goToView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`view-${viewId}`);
            if(target) { target.classList.remove('hidden'); document.querySelector('main').scrollTop = 0; }
            lucide.createIcons();
        }
        function goToHome() { goToView('pathology'); }

        function updateSidebarContext() {
            const pathEl = document.getElementById('ctx-pathology');
            const visitEl = document.getElementById('ctx-visit');
            const container = document.getElementById('sidebar-context');
            if (currentPatient.pathology) { container.classList.remove('opacity-50'); pathEl.textContent = pathologyData[currentPatient.pathology].name; } 
            else { container.classList.add('opacity-50'); pathEl.textContent = 'Seleccionar...'; }
            visitEl.textContent = currentPatient.visitType ? visitData[currentPatient.visitType] : 'Seleccionar...';
            
            const idInput = document.getElementById('patient-id-input');
            const nameInput = document.getElementById('patient-name-input');
            if(idInput && currentPatient.id) idInput.value = currentPatient.id;
            if(nameInput && currentPatient.name) nameInput.value = currentPatient.name;
        }

        function enableSideActions(enable) {
            document.getElementById('btn-pdf-side').disabled = !enable;
            document.getElementById('btn-copy-side').disabled = !enable;
        }

        // --- CONTENT RENDERER & HELPER FUNCTIONS ---
        // Helper functions defined here to avoid ReferenceError
        function getLivingWithDisease() {
            const advice = {
                'EA': 'Importancia del ejercicio diario, mantener buena postura, evitar sedentarismo',
                'APs': 'Cuidado de piel y articulaciones, control del peso, manejo del estrés',
                'AR': 'Protección articular, ejercicios de movilidad, adaptación actividades diarias',
                'LES': 'Fotoprotección estricta, prevención infecciones, manejo fatiga'
            };
            return advice[currentPatient.pathology] || 'Adaptaciones específicas según patología';
        }

        function getPrecautions() {
            const precautions = {
                'EA': 'Evitar traumatismos, mantener actividad física',
                'APs': 'Control peso, cuidado piel, evitar traumatismos',
                'AR': 'Anticoncepción si MTX, evitar infecciones',
                'LES': 'Fotoprotección, anticoncepción, evitar infecciones'
            };
            return precautions[currentPatient.pathology] || 'Según medicación prescrita';
        }

        function getAlarmSigns() {
            const signs = {
                'EA': 'Dolor torácico, uveítis, síntomas neurológicos',
                'APs': 'Articulación caliente+fiebre, dactilitis severa, eritrodermia',
                'AR': 'Fiebre+artritis, deformidad aguda, síntomas sistémicos',
                'LES': 'Convulsiones, confusión, disnea, edemas, hematuria'
            };
            return signs[currentPatient.pathology] || 'Signos específicos de gravedad';
        }

        function loadChecklistContent() {
            const container = document.getElementById('checklist-renderer');
            const title = document.getElementById('content-header-title');
            const dur = document.getElementById('dur-text');
            
            if(!title || !container) return;
            title.textContent = `${pathologyData[currentPatient.pathology].name} - ${visitData[currentPatient.visitType]}`;
            
            let html = '';
            let duration = '30 min';
            
            if (currentPatient.visitType === 'inicio') { html = getInicioTemplate(); duration = '45 min'; }
            else if (currentPatient.visitType === 'educacion') { html = getEducacionTemplate(); duration = '30 min'; }
            else if (currentPatient.visitType === 'postinicio') { html = getPostInicioTemplate(); duration = '20-25 min'; }
            else if (currentPatient.visitType === 'seguimiento') { html = getSeguimientoTemplate(); duration = '20-30 min'; }
            else if (currentPatient.visitType === 'brote') { html = getBroteTemplate(); duration = 'Variable'; }
            
            dur.textContent = duration;
            container.innerHTML = html;
            
            // Restore State
            Object.keys(currentPatient.checklist).forEach(id => { const cb = document.getElementById(id); if (cb) cb.checked = currentPatient.checklist[id]; });
            const evaInput = document.getElementById('eva-input');
            if (evaInput) {
                updateIntegerSelect('eva', currentPatient.eva || 0);
            }
            lucide.createIcons();
        }

        // --- COMPONENTS ---
        function createSection(title, icon, items) {
            return `<div class="bg-white rounded-xl border border-clinical-200 shadow-sm overflow-hidden"><div class="bg-clinical-50 px-6 py-4 border-b border-clinical-100 flex items-center gap-2"><i data-lucide="${icon}" class="text-clinical-500 w-5 h-5"></i><h3 class="font-bold text-clinical-800">${title}</h3></div><div class="p-6 space-y-4">${items}</div></div>`;
        }
        function createCheckbox(id, label) {
            return `<label class="flex items-start gap-3 cursor-pointer group"><div class="relative flex items-center"><input type="checkbox" id="${id}" onchange="toggleCheck('${id}')" class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-clinical-300 shadow-sm transition-all checked:border-accent-500 checked:bg-accent-500 hover:border-accent-400 focus:ring-2 focus:ring-accent-200 focus:ring-offset-1"><i data-lucide="check" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100 pointer-events-none"></i></div><div class="flex-1"><span class="text-clinical-700 group-hover:text-clinical-900 transition-colors">${label}</span></div></label>`;
        }
        function createCalcButton(calcType, label) {
            const hasScore = currentPatient.scores[calcType.toUpperCase()] !== undefined;
            const scoreVal = hasScore ? currentPatient.scores[calcType.toUpperCase()] : '';
            const statusClass = hasScore ? 'bg-accent-50 text-accent-700 border-accent-200' : 'bg-clinical-50 text-clinical-600 border-clinical-200 hover:border-accent-400';
            const checkId = `check_calc_${calcType}`; 
            return `<div class="flex items-center gap-2"><input type="checkbox" id="${checkId}" class="hidden" ${hasScore ? 'checked' : ''}><button onclick="openCalculator('${calcType}')" class="mt-2 flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-medium transition-all w-full md:w-auto ${statusClass}"><i data-lucide="calculator" class="w-4 h-4"></i><span>${label}</span>${hasScore ? `<span class="ml-2 font-bold">${scoreVal}</span>` : ''}</button></div>`;
        }

        // --- TEMPLATES ---
        function getInicioTemplate() {
            let calcs = '';
            if (currentPatient.pathology === 'EA') calcs = createCalcButton('basdai', 'Calcular BASDAI') + createCalcButton('asashi', 'ASAS Health Index');
            else if (currentPatient.pathology === 'APs') calcs = createCalcButton('psaid', 'Calcular PSAID') + createCalcButton('haq', 'Calcular HAQ-DI');
            else if (currentPatient.pathology === 'AR') calcs = createCalcButton('rapid3', 'Calcular RAPID3') + createCalcButton('haq', 'Calcular HAQ-DI');
            else if (currentPatient.pathology === 'LES') calcs = createCalcButton('sledai', 'Calcular SLEDAI-2K');

            return `
                ${createSection('Valoración Inicial Enfermera', 'clipboard-check', `
                    ${createCheckbox('val1', 'Completar datos de identificación (nombre, NUHSA, teléfono)')}
                    ${createCheckbox('val2', 'Confirmar diagnóstico principal y fecha')}
                    ${createCheckbox('val3', 'Revisar antecedentes personales (HTA, DM, dislipemia, tabaco, alergias)')}
                    ${createCheckbox('val4', 'Registrar tratamiento actual (FAMEs, biológicos, corticoides)')}
                    <div class="pt-2 pb-2">
                        <label class="text-sm font-medium text-clinical-700 block mb-2">Valorar dolor (EVA 0-10)</label>
                        ${createIntegerSelector('eva', null, 0, 10, 'updateEVA')}
                    </div>
                    <div><span class="text-sm font-medium text-clinical-700 block mb-2">Índices de Actividad:</span>${calcs}</div>
                `)}
                ${createSection('Educación en Salud', 'book-open', `
                    ${createCheckbox('edu1', `Explicar qué es ${currentPatient.pathologyName}`)}
                    ${createCheckbox('edu2', 'Informar que NO es contagioso y que hay tratamientos efectivos')}
                    ${createCheckbox('edu3', `Explicar cómo vivir con la enfermedad: ${getLivingWithDisease()}`)}
                    ${createCheckbox('edu4', 'Importancia del ejercicio físico regular y adaptado')}
                    ${createCheckbox('edu5', 'Signos de alarma: cuándo contactar con el servicio')}
                `)}
            `;
        }

        // ... (Similar logic for other templates, keeping it concise for file limit)
        function getEducacionTemplate() {
             return `
                ${createSection('Información sobre el Fármaco Prescrito', 'pill', `
                    ${createCheckbox('farm1', 'Explicar qué medicamento se ha prescrito y para qué sirve')}
                    ${createCheckbox('farm2', 'Dónde recoger la medicación (farmacia hospitalaria/oficina)')}
                    ${createCheckbox('farm3', 'Horario y procedimiento de recogida')}
                `)}
                ${createSection('Administración del Tratamiento', 'syringe', `
                    ${createCheckbox('admin1', 'Demostrar técnica de administración (si es inyectable)')}
                    ${createCheckbox('admin2', 'Explicar frecuencia y horario de administración')}
                    ${createCheckbox('admin3', 'Enseñar rotación de puntos de inyección (si aplica)')}
                    ${createCheckbox('admin4', 'Conservación del medicamento (nevera, temperatura ambiente)')}
                `)}
                ${createSection('Efectos Adversos y Precauciones', 'alert-circle', `
                    ${createCheckbox('efec1', 'Explicar efectos secundarios más frecuentes')}
                    ${createCheckbox('efec2', 'Qué hacer si aparecen efectos adversos leves')}
                    ${createCheckbox('efec3', 'Signos de alarma que requieren contacto urgente')}
                    ${createCheckbox('efec4', `Precauciones especiales: ${getPrecautions()}`)}
                `)}
                ${createSection('Expectativas y Adherencia', 'trending-up', `
                    ${createCheckbox('mej1', 'Explicar ritmo esperado de mejoría (semanas/meses)')}
                    ${createCheckbox('mej2', 'Importancia de no abandonar aunque no haya mejoría inmediata')}
                    ${createCheckbox('adh1', 'Explicar importancia de adherencia >95%')}
                    ${createCheckbox('adh2', 'Estrategias para no olvidar dosis (alarmas, apps)')}
                    ${createCheckbox('adh3', 'Qué hacer si olvida una dosis')}
                `)}
            `;
        }

        function getPostInicioTemplate() {
            let calcs = '';
            if (currentPatient.pathology === 'EA') calcs = createCalcButton('basdai', 'Calcular BASDAI');
            else if (currentPatient.pathology === 'APs') calcs = createCalcButton('psaid', 'Calcular PSAID');
            else if (currentPatient.pathology === 'AR') calcs = createCalcButton('rapid3', 'Calcular RAPID3');
            return `
                ${createSection('Verificación de Datos y Contexto', 'check-square', `
                    ${createCheckbox('ver1', 'Confirmar identidad y fecha inicio biológico')}
                    ${createCheckbox('ver2', 'Verificar fecha exacta de inicio tratamiento')}
                    ${createCheckbox('ver3', 'Confirmar medicamento y dosis')}
                    ${createCheckbox('ver4', 'Asegurar privacidad para la consulta')}
                `)}
                ${createSection('Evaluación Respuesta', 'bar-chart-2', `
                    ${createCheckbox('resp1', 'Valoración global subjetiva')}
                    <div class="pt-2 pb-2">
                        <label class="text-sm font-medium text-clinical-700 block mb-2">Dolor Actual (EVA 0-10)</label>
                        ${createIntegerSelector('eva', null, 0, 10, 'updateEVA')}
                    </div>
                    ${createCheckbox('resp3', 'Evaluar cambios en rigidez matutina')}
                    ${createCheckbox('resp4', 'Preguntar por mejoría en articulaciones inflamadas')}
                    ${createCheckbox('resp5', 'Valorar mejora funcional')}
                    <div><span class="text-sm font-medium text-clinical-700 block mb-2">Índices de Actividad:</span>${calcs}</div>
                `)}
                ${createSection('Seguridad y Efectos Secundarios', 'shield', `
                    ${createCheckbox('efec1', 'Preguntar por INFECCIONES desde el inicio')}
                    ${createCheckbox('efec2', 'Reacciones locales en sitio inyección')}
                    ${createCheckbox('efec3', 'Síntomas sistémicos nuevos')}
                    ${createCheckbox('efec4', 'Confirmar analítica de control')}
                    ${createCheckbox('efec5', `Signos de alarma específicos: ${getAlarmSigns()}`)}
                `)}
                ${createSection('Adherencia y Técnica', 'thumbs-up', `
                    ${createCheckbox('adh1', 'Confirmar administración según prescripción')}
                    ${createCheckbox('adh2', 'Verificar técnica (dificultades)')}
                    ${createCheckbox('adh3', 'Olvidos o problemas de suministro')}
                    ${createCheckbox('adh4', 'Revisar conservación del medicamento')}
                `)}
                ${createSection('Prevención y Cierre', 'calendar', `
                    ${createCheckbox('prev1', 'Recordar evitar contacto con enfermos')}
                    ${createCheckbox('prev2', 'Higiene de manos frecuente')}
                    ${createCheckbox('prev3', 'Recordar vacunación gripe/COVID')}
                    ${createCheckbox('dig1', 'Verificar registro de síntomas en papel/diario (si aplica)')}
                    ${createCheckbox('cont1', 'Proporcionar teléfono de dudas')}
                `)}
            `;
        }

        function getSeguimientoTemplate() {
            let calcs = '';
            if (currentPatient.pathology === 'EA') calcs = createCalcButton('basdai', 'Calcular BASDAI') + createCalcButton('asashi', 'ASAS Health Index');
            else if (currentPatient.pathology === 'APs') calcs = createCalcButton('psaid', 'Calcular PSAID') + createCalcButton('haq', 'Calcular HAQ-DI');
            else if (currentPatient.pathology === 'AR') calcs = createCalcButton('rapid3', 'Calcular RAPID3') + createCalcButton('haq', 'Calcular HAQ-DI');
            else if (currentPatient.pathology === 'LES') calcs = createCalcButton('sledai', 'Calcular SLEDAI-2K');

            return `
                ${createSection('Recordatorio y Analítica', 'history', `
                    ${createCheckbox('seg1', 'Informar esquema anual reumatólogo / semestral enfermería')}
                    ${createCheckbox('ana1', 'Revisar hemograma completo')}
                    ${createCheckbox('ana2', 'Comprobar función hepática y renal')}
                    ${createCheckbox('ana3', 'Verificar reactantes fase aguda (VSG, PCR)')}
                `)}
                ${createSection('Metrología y PROs', 'activity', `
                    <div class="pt-2 pb-2">
                        <label class="text-sm font-medium text-clinical-700 block mb-2">Valoración Dolor (EVA 0-10)</label>
                        ${createIntegerSelector('eva', null, 0, 10, 'updateEVA')}
                    </div>
                    <div><span class="text-sm font-medium text-clinical-700 block mb-2">Índice Actividad:</span>${calcs}</div>
                `)}
                ${createSection('Adherencia Terapéutica', 'pie-chart', `
                    ${createCalcButton('morisky', 'Test Morisky (MMAS-4)')}
                    ${createCalcButton('mars', 'Test MARS-5')}
                `)}
                ${createSection('Comorbilidades y Hechos', 'file-plus', `
                    ${createCheckbox('com1', 'Preguntar por nuevas enfermedades')}
                    ${createCheckbox('com2', 'Revisar efectos secundarios actuales')}
                    ${createCheckbox('com3', 'Control riesgo cardiovascular')}
                    ${createCheckbox('hec1', 'Hospitalizaciones o urgencias')}
                    ${createCheckbox('hec3', 'Infecciones o vacunas recibidas')}
                `)}
            `;
        }

        function getBroteTemplate() {
            let calcs = '';
            if (currentPatient.pathology === 'EA') calcs = createCalcButton('basdai', 'Calcular BASDAI');
            else if (currentPatient.pathology === 'APs') calcs = createCalcButton('psaid', 'Calcular PSAID');
            else if (currentPatient.pathology === 'AR') calcs = createCalcButton('rapid3', 'Calcular RAPID3');

            return `
                ${createSection('Evaluación Inicial del Brote', 'search', `
                    ${createCheckbox('bro1', 'Preguntar qué ha ocurrido (causa del brote)')}
                    ${createCheckbox('bro2', 'Tiempo de evolución síntomas')}
                    ${createCheckbox('bro3', 'Factores desencadenantes (estrés, infección)')}
                    ${createCheckbox('bro4', 'Medicación tomada para aliviar')}
                `)}
                ${createSection('Repetir PROs', 'bar-chart', `
                    <div class="pt-2 pb-2">
                        <label class="text-sm font-medium text-clinical-700 block mb-2">Dolor Brote (EVA 0-10)</label>
                        ${createIntegerSelector('eva', null, 0, 10, 'updateEVA')}
                    </div>
                    ${createCheckbox('pro2', 'Evaluar rigidez matutina (minutos)')}
                    ${createCheckbox('pro3', 'Limitación funcional actual vs basal')}
                    <div><span class="text-sm font-medium text-clinical-700 block mb-2">Índice Actividad:</span>${calcs}</div>
                `)}
                ${createSection('Evaluación Gravedad', 'alert-octagon', `
                    ${createCheckbox('gra1', 'Síntomas sistémicos (fiebre, peso)')}
                    ${createCheckbox('gra2', 'Número articulaciones afectadas')}
                    ${createCheckbox('gra3', 'Afectación actividades vida diaria')}
                    ${createCheckbox('gra4', `Signos de alarma: ${getAlarmSigns()}`)}
                `)}
                ${createSection('Medidas y Seguimiento', 'user-check', `
                    ${createCheckbox('med1', 'Ajustar analgesia según protocolo')}
                    ${createCheckbox('med2', 'Reposo relativo / frío-calor')}
                    ${createCheckbox('med4', 'Informar a reumatólogo (Cita <72h si grave)')}
                    ${createCheckbox('seg1', 'Programar llamada seguimiento 48-72h')}
                    ${createCheckbox('seg3', 'Explicar signos urgencia hospitalaria')}
                `)}
            `;
        }

        // --- CALCULATOR LOGIC (INPUT IMPROVEMENTS) ---
        let currentCalcType = null;
        function openCalculator(type) {
            currentCalcType = type;
            document.getElementById('calculator-panel').classList.remove('translate-x-full');
            document.getElementById('slide-over-backdrop').classList.remove('hidden');
            document.getElementById('calc-title').textContent = type.toUpperCase();
            document.getElementById('calc-body').innerHTML = getCalculatorForm(type);
            document.getElementById('calc-result-display').classList.add('hidden');
        }
        function closeCalculator() {
            document.getElementById('calculator-panel').classList.add('translate-x-full');
            document.getElementById('slide-over-backdrop').classList.add('hidden');
            currentCalcType = null;
            loadChecklistContent();
        }

        function toggleSledaiLab() {
            const hasLab = document.getElementById('sledai_lab_toggle').checked;
            const labSection = document.getElementById('sledai_lab_section');
            if(hasLab) labSection.classList.remove('hidden');
            else labSection.classList.add('hidden');
        }

        function getCalculatorForm(type) {
            if (type === 'basdai') {
                return `<div class="space-y-8">
                    <p class="text-sm text-clinical-500 italic">Por favor, marque el recuadro que representa su respuesta (0=Ausente, 10=Muy intenso). Todas las preguntas se refieren a la última semana.</p>
                    ${createIntegerSelector('bas_1', '1. ¿Cómo describiría el grado global de fatiga / cansancio que ha experimentado?', 0, 10)}
                    ${createIntegerSelector('bas_2', '2. ¿Cómo describiría el grado global de dolor en cuello, espalda o caderas debido a su enfermedad?', 0, 10)}
                    ${createIntegerSelector('bas_3', '3. ¿Cómo describiría el grado global de dolor-hinchazón en otras articulaciones fuera de cuello, espalda o caderas?', 0, 10)}
                    ${createIntegerSelector('bas_4', '4. ¿Cómo describiría el grado global de malestar que ha tenido en zonas dolorosas al tacto o a la presión?', 0, 10)}
                    ${createIntegerSelector('bas_5', '5. ¿Cómo describiría el grado global de rigidez matutina que ha tenido al despertar?', 0, 10)}
                    <div>
                        <label class="block text-sm mb-2 font-medium text-clinical-800">6. ¿Cuánto tiempo dura su rigidez matutina tras despertarse?</label>
                        <select id="bas_6" class="w-full p-3 border rounded-lg bg-white text-clinical-800">
                            <option value="0">0 horas</option><option value="2.5">1/2 hora</option><option value="5">1 hora</option>
                            <option value="7.5">1 hora y media</option><option value="10">2 horas o más</option>
                        </select>
                    </div>
                </div>`;
            }
            if (type === 'psaid') {
                return `<div class="space-y-8">
                    <p class="text-sm text-clinical-500 italic">Por favor díganos cómo se ha sentido usted durante la última semana (0=Nada, 10=Máximo).</p>
                    ${createIntegerSelector('ps_1', '1. Dolor: Rodee con un círculo el número que mejor describa el dolor que ha sentido debido a su artritis psoriásica.', 0, 10)}
                    ${createIntegerSelector('ps_2', '2. Fatiga/Cansancio: Rodee con un círculo el número que mejor describa la sensación de fatiga o cansancio que ha sentido.', 0, 10)}
                    ${createIntegerSelector('ps_3', '3. Problemas de la piel: Rodee con un círculo el número que mejor describa los problemas de la piel, incluyendo picor.', 0, 10)}
                    ${createIntegerSelector('ps_4', '4. Trabajo y/o actividades de ocio: Dificultades que ha tenido para desarrollar su trabajo y/o actividades de ocio.', 0, 10)}
                    ${createIntegerSelector('ps_5', '5. Capacidad funcional: Dificultad que ha tenido para hacer las actividades físicas cotidianas.', 0, 10)}
                    ${createIntegerSelector('ps_6', '6. Incomodidad/Irritación: Sensación de incomodidad y/o irritación que ha sentido.', 0, 10)}
                    ${createIntegerSelector('ps_7', '7. Dificultad para dormir: Dificultad para dormir (descansar por la noche).', 0, 10)}
                    ${createIntegerSelector('ps_8', '8. Afrontamiento: ¿Qué tal ha conseguido afrontar, sobrellevar o hacerse cargo de su enfermedad? (0=Muy bien, 10=Muy mal)', 0, 10)}
                    ${createIntegerSelector('ps_9', '9. Ansiedad, miedo e incertidumbre: Nivel de ansiedad, miedo e incertidumbre (futuro, tratamiento...).', 0, 10)}
                    ${createIntegerSelector('ps_10', '10. Apuro y/o vergüenza: Nivel de apuro y/o vergüenza por su apariencia.', 0, 10)}
                    ${createIntegerSelector('ps_11', '11. Participación social: Dificultades para participar de forma satisfactoria en actividades sociales.', 0, 10)}
                    ${createIntegerSelector('ps_12', '12. Depresión: Nivel de depresión (tristeza o estar depresivo).', 0, 10)}
                </div>`;
            }
            if (type === 'rapid3') {
                return `<div class="space-y-6">
                    <h4 class="font-bold border-b pb-2">1. Capacidad Funcional</h4>
                    <p class="text-xs text-clinical-500 mb-2">Durante la última semana, ¿ha sido capaz de...</p>
                    ${['a. Vestirse, incluyendo abrocharse los botones y atarse los cordones de los zapatos?','b. Acostarse y levantarse de la cama?','c. Llevar una taza o vaso lleno a la boca?','d. Caminar fuera de casa por un terreno llano?','e. Lavarse y secarse todo el cuerpo?','f. Agacharse para recoger ropa del suelo?','g. Abrir y cerrar grifos?','h. Entrar y salir de un coche, autobús o tren?','i. Caminar 3 km (o 2 millas) si lo desea?','j. Participar en actividades recreativas y deportes si lo desea?'].map((l,i)=>`
                        <div class="mb-4 bg-white p-3 rounded border border-clinical-100">
                            <p class="text-sm mb-2 font-medium text-clinical-800">${l}</p>
                            <div class="flex flex-col gap-2">
                                ${['Sin ninguna dificultad (0)', 'Con alguna dificultad (1)', 'Con mucha dificultad (2)', 'Incapaz de hacerlo (3)'].map((txt, v) => 
                                    `<label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-clinical-50 rounded"><input type="radio" name="rap_f${i+1}" value="${v}" class="text-accent-600 focus:ring-accent-500"><span class="text-sm">${txt}</span></label>`
                                ).join('')}
                            </div>
                        </div>`).join('')}
                    
                    <h4 class="font-bold text-clinical-900 border-b pb-2 mt-6">2. Evaluación del Dolor</h4>
                    ${createIntegerSelector('rap_pain', '¿Cuánto dolor ha tenido debido a su enfermedad durante la última semana? (0=Sin dolor, 10=El peor imaginable)', 0, 10)}
                    
                    <h4 class="font-bold text-clinical-900 border-b pb-2 mt-6">3. Evaluación Global</h4>
                    ${createIntegerSelector('rap_pga', 'Considerando todas las formas en que la enfermedad le afecta, ¿cómo se encuentra? (0=Muy bien, 10=Muy mal)', 0, 10)}
                </div>`;
            }
            if (type === 'haq') {
                 return `<div class="space-y-6">
                    <p class="text-sm text-clinical-500 italic">Durante la última semana, ¿ha sido capaz de...</p>
                    
                    ${[
                        {t:'1. Vestirse y asearse', q:['Vestirse solo, incluyendo abrocharse los botones y atarse los cordones','Enjabonarse la cabeza'], aid:'haq_aid_1'},
                        {t:'2. Levantarse', q:['Levantarse de una silla sin brazos','Acostarse y levantarse de la cama'], aid:'haq_aid_2'},
                        {t:'3. Comer', q:['Cortar un filete de carne','Abrir un cartón de leche nuevo','Servirse la bebida'], aid:'haq_aid_3'},
                        {t:'4. Caminar', q:['Caminar fuera de casa por un terreno llano','Subir cinco escalones'], aid:'haq_aid_4'},
                        {t:'5. Higiene', q:['Lavarse y secarse todo el cuerpo','Sentarse y levantarse del retrete','Ducharse'], aid:'haq_aid_5'},
                        {t:'6. Alcanzar', q:['Coger objeto de 1Kg encima de la cabeza','Agacharse y recoger ropa del suelo'], aid:'haq_aid_6'},
                        {t:'7. Prensión', q:['Abrir la puerta de un coche','Abrir tarros previamente abiertos','Abrir y cerrar grifos'], aid:'haq_aid_7'},
                        {t:'8. Otras Actividades', q:['Hacer los recados y las compras','Entrar y salir de un coche','Hacer tareas de casa (barrer, platos)'], aid:'haq_aid_8'}
                    ].map((cat, idx) => `
                        <div class="bg-clinical-50 p-4 rounded-lg border border-clinical-200">
                            <h5 class="font-bold text-sm mb-3 text-clinical-900 uppercase tracking-wide border-b pb-1 border-clinical-200">${cat.t}</h5>
                            ${cat.q.map((qtext, qidx) => {
                                return `<div class="mb-4">
                                    <p class="text-sm mb-2 font-medium text-clinical-800">${qtext}</p>
                                    <div class="flex flex-col gap-1 bg-white p-2 rounded border border-clinical-100">
                                        ${['Sin dificultad (0)', 'Con alguna dificultad (1)', 'Con mucha dificultad (2)', 'Incapaz de hacerlo (3)'].map((txt, v) => 
                                            `<label class="flex items-center gap-2 cursor-pointer hover:bg-clinical-50 p-1 rounded"><input type="radio" name="haq_cat_${idx}_q_${qidx}" value="${v}" class="text-accent-600"><span class="text-sm">${txt}</span></label>`
                                        ).join('')}
                                    </div>
                                </div>`;
                            }).join('')}
                            <label class="flex items-center gap-2 text-sm mt-2 font-bold text-clinical-700 bg-white p-2 rounded border"><input type="checkbox" id="${cat.aid}" class="custom-checkbox w-4 h-4"> Necesita ayuda de otra persona o utensilios</label>
                        </div>
                    `).join('')}
                 </div>`;
            }
            if (type === 'asashi') {
                return `<div class="space-y-4 text-sm">
                    <h4 class="font-bold text-clinical-800 border-b pb-2">ASAS Health Index</h4>
                    <p class="text-xs text-clinical-500 mb-2">Por favor, seleccione la respuesta para cada afirmación:</p>
                    ${[
                        '1. El dolor, a veces, trastorna mis actividades normales.',
                        '2. Me resulta difícil estar de pie mucho tiempo.',
                        '3. Tengo problemas para correr.',
                        '4. Tengo problemas para usar el váter.',
                        '5. A menudo estoy agotado.',
                        '6. Estoy menos motivado para realizar actividades que requieran esfuerzo físico.',
                        '7. He perdido el interés por el sexo.',
                        '8. Tengo dificultad para manejar los pedales en mi coche.',
                        '9. Me resulta difícil establecer comunicación con la gente.',
                        '10. Soy incapaz de caminar fuera de casa por un terreno llano.',
                        '11. Me resulta difícil concentrarme.',
                        '12. Estoy limitado para viajar debido a mi movilidad.',
                        '13. A menudo me siento frustrado.',
                        '14. Me resulta difícil lavarme el pelo.',
                        '15. He tenido cambios económicos debido a mi enfermedad reumática.',
                        '16. Duermo mal por la noche.',
                        '17. No puedo superar mis dificultades.'
                    ].map((q,i)=>`
                        <div class="p-3 bg-white rounded border border-clinical-100 hover:border-accent-300 transition-colors">
                            <p class="mb-2 font-medium text-clinical-800">${q}</p>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="asas_${i+1}" value="1" class="text-accent-600 focus:ring-accent-500"> Estoy de acuerdo</label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="asas_${i+1}" value="0" class="text-accent-600 focus:ring-accent-500"> No estoy de acuerdo</label>
                            </div>
                        </div>`).join('')}
                </div>`;
            }
            if (type === 'sledai') {
                return `<div class="space-y-4 text-sm">
                    <h4 class="font-bold text-clinical-800">SLEDAI-2K</h4>
                    <div class="flex items-center justify-between p-3 bg-white border rounded mb-2">
                        <span class="font-bold text-clinical-700">¿Analítica disponible?</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sledai_lab_toggle" class="sr-only peer" onchange="toggleSledaiLab()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-500"></div>
                        </label>
                    </div>
                    
                    <div class="bg-red-50 p-3 rounded border border-red-100">
                        <h5 class="font-bold text-red-800 text-xs mb-2">GRAVE (8 pts)</h5>
                        ${['Convulsiones','Psicosis','Sdme orgánico-cerebral','Alteraciones visuales','Alt. Pares craneales','Cefalea lúpica','AVC','Vasculitis'].map((l,i)=>`<label class="flex items-center gap-2 mb-1"><input type="checkbox" id="sle_8_${i}" class="custom-checkbox"> ${l}</label>`).join('')}
                    </div>
                    <div class="bg-orange-50 p-3 rounded border border-orange-100">
                        <h5 class="font-bold text-orange-800 text-xs mb-2">MODERADO (4 pts)</h5>
                        ${['Miositis','Artritis','Cilindros urinarios','Hematuria','Proteinuria','Piuria'].map((l,i)=>`<label class="flex items-center gap-2 mb-1 ${i>1?'lab-item hidden':''}" ${i>1?'data-lab="true"':''}><input type="checkbox" id="sle_4_${i}" class="custom-checkbox"> ${l}</label>`).join('')}
                    </div>
                    <div id="sledai_lab_section" class="hidden">
                        <div class="bg-yellow-50 p-3 rounded border border-yellow-100 mt-2">
                            <h5 class="font-bold text-yellow-800 text-xs mb-2">LEVE / LAB (2 pts)</h5>
                            ${['Complemento bajo','Anti DNA aumentado'].map((l,i)=>`<label class="flex items-center gap-2 mb-1"><input type="checkbox" id="sle_2_lab_${i}" class="custom-checkbox"> ${l}</label>`).join('')}
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded border border-yellow-100">
                         <h5 class="font-bold text-yellow-800 text-xs mb-2">LEVE / CLINICO (2 pts)</h5>
                         ${['Exantema nuevo','Alopecia','Ulceras bucales','Pleuritis','Pericarditis'].map((l,i)=>`<label class="flex items-center gap-2 mb-1"><input type="checkbox" id="sle_2_cli_${i}" class="custom-checkbox"> ${l}</label>`).join('')}
                    </div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-100">
                        <h5 class="font-bold text-blue-800 text-xs mb-2">OTROS (1 pt)</h5>
                        ${['Fiebre','Trombopenia (Lab)','Leucopenia (Lab)'].map((l,i)=>`<label class="flex items-center gap-2 mb-1"><input type="checkbox" id="sle_1_${i}" class="custom-checkbox"> ${l}</label>`).join('')}
                    </div>
                </div>`;
            }
            if(type === 'morisky') {
                 return `<div class="space-y-4">
                    <h4 class="font-bold border-b pb-2">Morisky-Green (4 ítems)</h4>
                    ${['1. ¿Olvida alguna vez tomar los medicamentos para tratar su enfermedad?','2. ¿Toma los medicamentos a la hora indicada?','3. Cuando se encuentra bien, ¿deja de tomar la medicación?','4. Si alguna vez le sienta mal, ¿deja de tomarla?'].map((q,i)=>`
                        <div class="flex justify-between items-center p-3 bg-white border rounded mb-2"><span class="text-sm w-2/3 font-medium">${q}</span><div class="flex gap-2">
                        <label class="text-sm border px-3 py-1 rounded cursor-pointer hover:bg-clinical-50"><input type="radio" name="mor_${i}" value="${i===1?'1':'0'}" class="mr-1">Sí</label>
                        <label class="text-sm border px-3 py-1 rounded cursor-pointer hover:bg-clinical-50"><input type="radio" name="mor_${i}" value="${i===1?'0':'1'}" class="mr-1">No</label></div></div>`).join('')}
                 </div>`;
            }
            if(type === 'mars') {
                 return `<div class="space-y-4">
                    <h4 class="font-bold border-b pb-2">MARS-5</h4>
                    <p class="text-xs text-gray-500">1=Siempre ... 5=Nunca</p>
                    ${['1. Me olvido de tomarlos','2. Modifico la dosis','3. Dejo de tomarlos durante un tiempo','4. Decido no tomar alguna dosis','5. Tomo menos cantidad de la prescrita'].map((q,i)=>`
                        <div class="mb-4 bg-white p-3 border rounded">
                            <p class="text-sm mb-2 font-medium">${q}</p>
                            <div class="flex justify-between">
                                ${['Siempre (1)','A menudo (2)','A veces (3)','Rara vez (4)','Nunca (5)'].map((l,v) => 
                                    `<label class="flex flex-col items-center cursor-pointer"><input type="radio" name="mar_${i}" value="${v+1}" class="mb-1"><span class="text-xs text-gray-600">${l}</span></label>`
                                ).join('')}
                            </div>
                        </div>`).join('')}
                 </div>`;
            }
            return '';
        }

        function createIntegerSelector(id, label, min, max, changeFn = null) {
            let html = `<div>`;
            if(label) {
                html += `<div class="flex justify-between mb-2"><label class="text-sm font-medium text-clinical-800 flex-1">${label}</label></div>`;
            }
            html += `<div class="grid grid-cols-11 gap-1" id="${id}_container">`;
            for(let i=min; i<=max; i++) {
                // Generar botones. Onclick actualiza un input hidden y estilo visual
                html += `<div class="num-btn" onclick="selectInteger('${id}', ${i}, ${changeFn ? '\'' + changeFn + '\'' : 'null'})" id="${id}_btn_${i}">${i}</div>`;
            }
            html += `</div><input type="hidden" id="${id}" value=""></div>`;
            return html;
        }

        function selectInteger(id, value, changeFn) {
            // Update hidden input
            const input = document.getElementById(id);
            if(input) input.value = value;
            
            // Visual feedback
            const container = document.getElementById(`${id}_container`);
            container.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`${id}_btn_${value}`).classList.add('selected');

            // Optional callback (for EVA live update)
            if(changeFn && typeof window[changeFn] === 'function') {
                window[changeFn](value);
            }
        }
        
        // Helper to update integer selector UI from stored value
        function updateIntegerSelect(id, value) {
            const btn = document.getElementById(`${id}_btn_${value}`);
            if(btn) selectInteger(id, value, null);
        }

        function performCalculation() {
            let result = 0, txt = '', colorClass = 'bg-gray-50 border-gray-200 text-gray-800';
            
            if (currentCalcType === 'basdai') {
                let s = 0; for(let i=1; i<=4; i++) s += parseFloat(document.getElementById(`bas_${i}`).value)||0;
                let s2 = (parseFloat(document.getElementById('bas_5').value)||0 + parseFloat(document.getElementById('bas_6').value)||0)/2;
                result = 0.2 * (s + s2); // Formula Correcta: 0.2 * (Q1+Q2+Q3+Q4 + (Q5+Q6)/2)
                if(result >= 4) colorClass = 'bg-red-50 border-red-200 text-red-800';
                else colorClass = 'bg-green-50 border-green-200 text-green-800';
                txt = `BASDAI: ${result.toFixed(1)} (${result>=4?'Actividad Alta':'Controlada'})`;
            } 
            else if (currentCalcType === 'rapid3') {
                let f = 0; 
                // Sumar radio buttons de función
                for(let i=1; i<=10; i++) {
                    const radios = document.getElementsByName(`rap_f${i}`);
                    for(let r of radios) if(r.checked) f += parseFloat(r.value);
                }
                let fn = f / 3; 
                let p = parseFloat(document.getElementById('rap_pain').value)||0;
                let g = parseFloat(document.getElementById('rap_pga').value)||0;
                result = fn + p + g; 
                if(result > 12) colorClass = 'bg-red-50 border-red-200 text-red-800';
                else if(result > 6) colorClass = 'bg-orange-50 border-orange-200 text-orange-800';
                else colorClass = 'bg-green-50 border-green-200 text-green-800';
                txt = `RAPID3: ${result.toFixed(1)} / 30`;
            }
            else if (currentCalcType === 'haq') {
                // HAQ Logic con radio buttons
                const categories = 8;
                let sum = 0, valid = 0;
                // Simplificado para demo: asumimos 2 preguntas por cat (aprox)
                // Iterar categorías 0-7
                for(let c=0; c<8; c++) {
                    let maxCat = 0;
                    // Check items in cat (id scheme haq_cat_C_q_Q)
                    for(let q=0; q<3; q++) { // Max 3 preguntas/cat
                        const radios = document.getElementsByName(`haq_cat_${c}_q_${q}`);
                        if(radios.length > 0) {
                            for(let r of radios) if(r.checked) maxCat = Math.max(maxCat, parseFloat(r.value));
                        }
                    }
                    const aid = document.getElementById(`haq_aid_${c+1}`);
                    if(aid && aid.checked && maxCat < 2) maxCat = 2;
                    sum += maxCat; valid++;
                }
                result = sum/valid;
                if(result > 2) colorClass = 'bg-red-50 border-red-200 text-red-800';
                else if(result > 1) colorClass = 'bg-orange-50 border-orange-200 text-orange-800';
                else colorClass = 'bg-green-50 border-green-200 text-green-800';
                txt = `HAQ-DI: ${result.toFixed(2)}`;
            }
            else if (currentCalcType === 'psaid') {
                let s = 0;
                const weights = [3,2,2,2,2,2,2,1,1,1,1,1]; 
                for(let i=1; i<=12; i++) s += (parseFloat(document.getElementById(`ps_${i}`).value)||0) * weights[i-1];
                result = s / 20;
                if(result >= 4) colorClass = 'bg-red-50 border-red-200 text-red-800';
                else colorClass = 'bg-green-50 border-green-200 text-green-800';
                txt = `PSAID: ${result.toFixed(1)} / 10`;
            }
            else if (currentCalcType === 'asashi') {
                let s = 0;
                for(let i=1; i<=17; i++) {
                    const radios = document.getElementsByName(`asas_${i}`);
                    for(let r of radios) if(r.checked) s += parseInt(r.value);
                }
                result = s;
                if(result >= 10) colorClass = 'bg-red-50 border-red-200 text-red-800';
                else colorClass = 'bg-gray-50 border-gray-200 text-gray-800';
                txt = `ASAS-HI: ${result} / 17 (0=Buena, 17=Mala)`;
            }
            else if (currentCalcType === 'sledai') {
                let s = 0;
                const lab = document.getElementById('sledai_lab_toggle').checked;
                // Sumar todos los checkboxes
                document.querySelectorAll('#calculator-panel input[type="checkbox"]').forEach(cb => {
                    if(cb.id.startsWith('sle_') && cb.checked) {
                        if(cb.id.includes('_8_')) s+=8;
                        if(cb.id.includes('_4_')) s+=4;
                        if(cb.id.includes('_2_')) s+=2;
                        if(cb.id.includes('_1_')) s+=1;
                    }
                });
                result = s;
                if(result >= 6) colorClass = 'bg-red-50 border-red-200 text-red-800';
                else if(result > 0) colorClass = 'bg-orange-50 border-orange-200 text-orange-800';
                else colorClass = 'bg-green-50 border-green-200 text-green-800';
                txt = `SLEDAI-2K ${lab ? '' : '(Clínico)'}: ${result}`;
            }
            else if (currentCalcType === 'morisky') {
                 let correct = 0;
                 for(let i=0; i<4; i++) {
                    const radios = document.getElementsByName(`mor_${i}`);
                    for(let r of radios) if(r.checked && r.value === '1') correct++; 
                 }
                 result = correct;
                 if(result < 4) colorClass = 'bg-orange-50 border-orange-200 text-orange-800';
                 else colorClass = 'bg-green-50 border-green-200 text-green-800';
                 txt = result === 4 ? "Adherente (4/4)" : "No Adherente (<4)";
            }
            else if (currentCalcType === 'mars') {
                let s = 0; 
                for(let i=0; i<5; i++) {
                    const radios = document.getElementsByName(`mar_${i}`);
                    for(let r of radios) if(r.checked) s += parseFloat(r.value);
                }
                result = s;
                if(result >= 23) colorClass = 'bg-green-50 border-green-200 text-green-800';
                else colorClass = 'bg-orange-50 border-orange-200 text-orange-800';
                txt = `MARS-5: ${result}/25`;
            }

            // Save and Feedback
            currentPatient.scores[currentCalcType.toUpperCase()] = typeof result === 'number' ? result.toFixed(1) : result;
            
            // Mark checklist
            const check = document.getElementById(`check_calc_${currentCalcType}`);
            if(check) { check.checked = true; saveState(); }

            // Display
            const d = document.getElementById('calc-result-display'); 
            d.textContent = txt; 
            d.className = `mt-3 p-4 rounded-lg text-center font-bold text-lg border ${colorClass}`;
            d.classList.remove('hidden');
            
            saveState(); 
            checkAlerts();
        }

        // --- ALERTS ---
        function checkAlerts() {
            const container = document.getElementById('alerts-area'); if(!container) return; container.innerHTML = '';
            
            if (currentPatient.eva >= 7) addAlert(container, 'Dolor Severo', `EVA ${currentPatient.eva}. Evaluar ajuste.`, 'alert-octagon', 'bg-red-50 text-red-800 border-red-200');
            if (currentPatient.scores['BASDAI'] >= 4) addAlert(container, 'Actividad Alta', `BASDAI > 4.`, 'trending-up', 'bg-orange-50 text-orange-800 border-orange-200');
            if (currentPatient.scores['RAPID3'] >= 12) addAlert(container, 'Gravedad Alta', `RAPID3 > 12.`, 'alert-triangle', 'bg-red-50 text-red-800 border-red-200');
            if (currentPatient.scores['SLEDAI'] >= 6) addAlert(container, 'Actividad Lúpica', `SLEDAI > 6.`, 'shield-alert', 'bg-red-50 text-red-800 border-red-200');
        }

        function addAlert(container, title, msg, icon, classes) {
            container.innerHTML += `<div class="p-4 rounded-lg border flex items-start gap-3 ${classes}"><i data-lucide="${icon}" class="w-5 h-5 mt-0.5"></i><div><h4 class="font-bold text-sm">${title}</h4><p class="text-sm opacity-90">${msg}</p></div></div>`;
            lucide.createIcons();
        }

        // --- STATE MANAGEMENT ---
        function toggleCheck(id) {
            const cb = document.getElementById(id);
            currentPatient.checklist[id] = cb.checked;
            saveState();
        }
        function updateEVA(val) {
            currentPatient.eva = val;
            const disp = document.getElementById('eva-display'); if(disp) disp.textContent = val;
            checkAlerts(); saveState();
        }
        function updateEvaDisplay(val) {
            const disp = document.getElementById('eva-display'); if(disp) disp.textContent = val;
        }
        function triggerReset() { openModal('Reiniciar Paciente', 'Se borrarán todos los datos actuales. ¿Continuar?', executeReset); }
        function executeReset() { closeModal(); localStorage.removeItem('reuma_state_v3'); currentPatient = { id:'', name: '', pathology: null, visitType: null, eva: null, scores: {}, checklist: {}, alerts: [] }; goToView('pathology'); updateSidebarContext(); enableSideActions(false); showToast("Sesión reiniciada"); }

        function openModal(title, msg, onConfirm) {
            const m = document.getElementById('confirmation-modal');
            document.getElementById('modal-message').textContent = msg;
            const btn = document.getElementById('modal-confirm-btn');
            const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', onConfirm);
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.add('modal-enter-active'); m.querySelector('.relative').classList.add('modal-content-active'); }, 10);
        }
        function closeModal() {
            const m = document.getElementById('confirmation-modal');
            m.classList.remove('modal-enter-active'); m.querySelector('.relative').classList.remove('modal-content-active');
            setTimeout(() => m.classList.add('hidden'), 200);
        }
        function saveState() { localStorage.setItem('reuma_state_v3', JSON.stringify(currentPatient)); }
        function loadState() {
            const s = localStorage.getItem('reuma_state_v3');
            if(s) { 
                currentPatient = JSON.parse(s); updateSidebarContext(); 
                if(currentPatient.pathology) {
                    if(currentPatient.visitType) { loadChecklistContent(); goToView('content'); enableSideActions(true); checkAlerts(); }
                    else goToView('visit');
                }
            }
        }

        // --- EXPORT ---
        async function generateSummary() {
            let t = `HOSPITAL: ${sessionSettings.hospital || ''}\nPROFESIONAL: ${sessionSettings.nurse || ''}\n`;
            t += `PACIENTE: ${currentPatient.name || ''} ${currentPatient.id ? `(${currentPatient.id})` : ''}\nPATOLOGÍA: ${currentPatient.pathologyName}\nVISITA: ${currentPatient.visitName}\nFECHA: ${new Date().toLocaleDateString()}\n\n`;
            if(currentPatient.eva) t += `EVA: ${currentPatient.eva}\n`;
            for(let k in currentPatient.scores) t += `${k}: ${currentPatient.scores[k]}\n`;
            t += `\nINTERVENCIONES:\n`;
            for(let k in currentPatient.checklist) if(currentPatient.checklist[k]) {
                const el = document.getElementById(k); if(el) t += `[x] ${el.closest('label').querySelector('span').textContent}\n`;
            }
            try { await navigator.clipboard.writeText(t); showToast("Copiado al portapapeles"); } catch(e) { fallbackCopy(t); }
        }
        function fallbackCopy(t) {
            const a = document.createElement("textarea"); a.value = t; document.body.appendChild(a); a.select(); document.execCommand('copy'); document.body.removeChild(a); showToast("Copiado (fallback)");
        }
        function showToast(m) { const t = document.getElementById('toast'); document.getElementById('toast-message').textContent = m; t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(()=>t.classList.add('translate-y-20', 'opacity-0'), 3000); }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(16); doc.text("INFORME REUMACARE", 20, 20);
            
            doc.setFontSize(10);
            doc.text(`Centro: ${sessionSettings.hospital || '__________'}`, 20, 30);
            doc.text(`Profesional: ${sessionSettings.nurse || '__________'}`, 20, 35);

            doc.setFontSize(12); 
            doc.text(`Paciente: ${currentPatient.name || ''} ${currentPatient.id ? `(ID: ${currentPatient.id})` : ''}`, 20, 45);
            doc.text(`Patología: ${currentPatient.pathologyName}`, 20, 52); doc.text(`Visita: ${currentPatient.visitName}`, 20, 59);
            
            let y = 70;
            if(currentPatient.eva) { doc.text(`EVA: ${currentPatient.eva}`, 20, y); y+=10; }
            for(let k in currentPatient.scores) { doc.text(`${k}: ${currentPatient.scores[k]}`, 20, y); y+=10; }
            doc.save("Informe.pdf"); showToast("PDF Generado");
        }
    </script>
</body>
</html>
